<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirino Obsidian - Joystick Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            font-family: 'Consolas', 'Monaco', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 80vw;
            height: 70vh;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid #4a4a6a;
            border-radius: 15px;
            position: relative;
            box-shadow: 
                0 0 30px rgba(100, 100, 150, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .alpine-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(255,255,255,0.7);
            z-index: 20;
        }
        
        .crosshair {
            position: absolute;
            width: 40px;
            height: 40px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s ease;
            z-index: 30;
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .crosshair::before {
            width: 40px;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        .crosshair::after {
            width: 2px;
            height: 40px;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .center-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ff4444;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #ff4444;
        }
        
        .coordinates {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ff88;
            font-size: 16px;
            text-shadow: 0 0 5px #00ff88;
            z-index: 20;
        }
        
        .joystick-info {
            position: absolute;
            top: 60px;
            left: 20px;
            color: #8888aa;
            font-size: 12px;
            z-index: 20;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: #8888aa;
            font-size: 12px;
            text-align: right;
            z-index: 20;
        }
        
        .grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            background-image: 
                linear-gradient(rgba(100, 100, 150, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 100, 150, 0.3) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            box-shadow: 0 0 8px #ff4444;
            z-index: 20;
        }
        
        .status-indicator.connected {
            background: #00ff88;
            box-shadow: 0 0 8px #00ff88;
        }
        
        /* Arganelli rossi */
        .winch {
            position: absolute;
            width: 40px;
            height: 25px;
            background: #ff3333;
            border: 2px solid #ff6666;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(255, 51, 51, 0.5);
            top: 60px;
            z-index: 20;
        }
        
        .winch-left {
            left: 80px;
        }
        
        .winch-right {
            right: 80px;
        }
        
        .winch::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffaaaa;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Robot triangolare viola */
        .robot {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 35px solid #8833ff;
            filter: drop-shadow(0 0 8px rgba(136, 51, 255, 0.6));
            z-index: 20;
        }
        
        .robot::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 25px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 10px solid #aa66ff;
        }
        
        /* Linee tratteggiate migliorate */
        .dashed-line {
            position: absolute;
            border-top: 2px dashed #66aaff;
            opacity: 0.7;
            filter: drop-shadow(0 0 3px rgba(102, 170, 255, 0.3));
            transform-origin: left center;
            z-index: 10;
        }
        
        .line-left {
            /* Posizionata dinamicamente via JavaScript */
        }
        
        .line-right {
            /* Posizionata dinamicamente via JavaScript */
        }
        
        /* Linee tratteggiate verso il mirino */
        .crosshair-line {
            position: absolute;
            border-top: 2px dashed #55ccff;
            opacity: 0.7;
            filter: drop-shadow(0 0 3px rgba(85, 204, 255, 0.5));
            transform-origin: left center;
            z-index: 15;
        }
        
        .crosshair-line-left {
            /* Posizionata dinamicamente via JavaScript */
        }
        
        .crosshair-line-right {
            /* Posizionata dinamicamente via JavaScript */
        }
        
        /* Vettore distanza */
        .distance-vector {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #ffaa00, #ff6600);
            box-shadow: 0 0 6px rgba(255, 170, 0, 0.8);
            transform-origin: left center;
            opacity: 0.9;
            transition: all 0.05s ease;
            z-index: 25;
        }
        
        .distance-vector::after {
            content: '';
            position: absolute;
            right: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 10px solid #ff6600;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            filter: drop-shadow(0 0 4px rgba(255, 102, 0, 0.6));
        }
        
        .distance-label {
            position: absolute;
            color: #ffaa00;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 0 0 4px rgba(255, 170, 0, 0.8);
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            backdrop-filter: blur(5px);
            transition: all 0.05s ease;
            z-index: 25;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="alpine-title">alpine robot</div>
        <div class="grid"></div>
        
        <!-- Arganelli rossi -->
        <div class="winch winch-left" title="Arganello Sinistro"></div>
        <div class="winch winch-right" title="Arganello Destro"></div>
        
        <!-- Robot triangolare viola -->
        <div class="robot" title="Robot"></div>
        
        <!-- Linee tratteggiate di collegamento -->
        <div class="dashed-line line-left" id="lineLeft"></div>
        <div class="dashed-line line-right" id="lineRight"></div>
        
        <!-- Nuove linee tratteggiate verso il mirino -->
        <div class="crosshair-line crosshair-line-left" id="crosshairLineLeft"></div>
        <div class="crosshair-line crosshair-line-right" id="crosshairLineRight"></div>
        
        <!-- Vettore distanza -->
        <div class="distance-vector" id="distanceVector"></div>
        <div class="distance-label" id="distanceLabel">ΔX: 0, ΔY: 0</div>
        
        <div class="crosshair" id="crosshair">
            <div class="center-dot"></div>
        </div>
        <div class="coordinates" id="coordinates">X: 0, Y: 0</div>
        <div class="joystick-info" id="joystick-info">
            Axis 0: 0.000<br>
            Axis 1: 0.000
        </div>
        <div class="controls">
            Controllo tramite Joystick ROS2<br>
            Topic: /joy | Assi: 0 (X), 1 (Y)<br>
            🔴 Arganelli | 🔷 Robot | ⊹ Mirino | → Vettore<br>
            ⎯ Linee blu: collegamento arganelli-mirino<br>
            FREEZE: Axis4 = -1
        </div>
        <div class="status-indicator" id="status"></div>
    </div>
    
    <script>
        const crosshair       = document.getElementById('crosshair');
        const coordinates     = document.getElementById('coordinates');
        const joystickInfo    = document.getElementById('joystick-info');
        const statusIndicator = document.getElementById('status');
        const container       = document.getElementById('container');
        const lineLeft        = document.getElementById('lineLeft');
        const lineRight       = document.getElementById('lineRight');
        const crosshairLineLeft  = document.getElementById('crosshairLineLeft');
        const crosshairLineRight = document.getElementById('crosshairLineRight');
        const distanceVector  = document.getElementById('distanceVector');
        const distanceLabel   = document.getElementById('distanceLabel');
        
        /* ---------- CONFIG ---------- */
        const STORE_NAME = 'crosshair';               // <— NOTA: cambai qua se vuoi altri state “joy”, “camera” …
        const STATE_URL  = `/state/${STORE_NAME}`;
        const UPDATE_URL = `/update/${STORE_NAME}`;
        let lastUpdate = Date.now();
        let currentState = { x: 0, y: 0, robot_x: 0, robot_y: 0 };

        function updateGeometry(crosshairX, crosshairY, robotX, robotY) {
            const containerRect = container.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;

            // Arrow triangle dimensions (match your CSS exactly!)
            const arrowHeight = 35; // height from CSS (border-bottom: 35px solid)
            const tipOffsetY = arrowHeight / 2; // vertical offset from center to tip (upward)

            // Robot's center position
            const robotCenterX = containerWidth / 2 + robotX;
            const robotCenterY = containerHeight / 2 + robotY;

            // Arrow tip exact position
            const arrowTipX = robotCenterX;
            const arrowTipY = robotCenterY - tipOffsetY;

            // Position the purple arrow (CSS triangle visual)
            const robot = document.querySelector('.robot');
            robot.style.left = robotCenterX + 'px';
            robot.style.top = (robotCenterY - tipOffsetY) + 'px';  // Arrow top-left CSS position adjustment

            // Position the crosshair exactly at the arrow tip by default
            const crosshair = document.getElementById('crosshair');
            crosshair.style.left = (arrowTipX + crosshairX) + 'px';
            crosshair.style.top = (arrowTipY + crosshairY) + 'px';
            crosshair.style.transform = `translate(-50%, -50%)`;

            // Winches position (fixed)
            const winchLeftX = 100;
            const winchLeftY = 72.5;
            const winchRightX = containerWidth - 100;
            const winchRightY = 72.5;

            // Dashed lines from winches directly to arrow tip
            updateDashedLine(lineLeft, winchLeftX, winchLeftY, arrowTipX, arrowTipY);
            updateDashedLine(lineRight, winchRightX, winchRightY, arrowTipX, arrowTipY);

            // Vector from arrow tip to displaced crosshair (useful if joystick moves crosshair)
            const deltaX = crosshairX;
            const deltaY = crosshairY;
            const vectorDistance = Math.sqrt(deltaX**2 + deltaY**2);
            const vectorAngle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;

            if (vectorDistance > 5) {
                distanceVector.style.display = 'block';
                distanceVector.style.left = arrowTipX + 'px';
                distanceVector.style.top = arrowTipY + 'px';
                distanceVector.style.width = vectorDistance + 'px';
                distanceVector.style.transform = `rotate(${vectorAngle}deg)`;

                const labelX = arrowTipX + deltaX * 0.5;
                const labelY = arrowTipY + deltaY * 0.5 - 20;

                distanceLabel.style.display = 'block';
                distanceLabel.style.left = labelX + 'px';
                distanceLabel.style.top = labelY + 'px';
                distanceLabel.textContent = `ΔX: ${Math.round(deltaX)}, ΔY: ${Math.round(deltaY)}`;
            } else {
                distanceVector.style.display = 'none';
                distanceLabel.style.display = 'none';
            }
        }

        // Keep track of robot-relative positions clearly
        async function pollState() {
            while (true) {
                try {
                    const res = await fetch('/state');
                    const data = await res.json();

                    coordinates.textContent = `X: ${Math.round(data.x)}, Y: ${Math.round(data.y)}`;
                    joystickInfo.innerHTML = `Axis 0: ${data.axis0.toFixed(3)}<br>Axis 1: ${data.axis1.toFixed(3)}`;

                    updateGeometry(data.x, data.y, data.robot_x, data.robot_y);

                    const now = Date.now();
                    statusIndicator.classList.toggle('connected', now - lastUpdate < 1000);
                    lastUpdate = now;

                } catch (e) {
                    console.error('Errore connessione:', e);
                    statusIndicator.classList.remove('connected');
                }

                await new Promise(r => setTimeout(r, 50));
            }
        }


        
        function updateDashedLine(line, startX, startY, endX, endY) {
            const dx = endX - startX;
            const dy = endY - startY;
            const distance = Math.hypot(dx, dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            line.style.left   = startX + 'px';
            line.style.top    = startY + 'px';
            line.style.width  = distance + 'px';
            line.style.transform = `rotate(${angle}deg)`;
        }
        
        
        /* ---------- POLLING ---------- */
        async function pollState() {
            while (true) {
                try {
                    const res  = await fetch(STATE_URL);   // <— usa l’endpoint parametrico
                    const data = await res.json();

                    currentState = data;

                    coordinates.textContent =
                        `X: ${Math.round(data.x)}, Y: ${Math.round(data.y)}`;

                    joystickInfo.innerHTML =
                        `Axis 0: ${data.axis0.toFixed(3)}<br>Axis 1: ${data.axis1.toFixed(3)}`;

                    updateGeometry(data.x, data.y, data.robot_x, data.robot_y);

                    const now = Date.now();
                    statusIndicator.classList.toggle('connected', now - lastUpdate < 1000);
                    lastUpdate = now;
                } catch (e) {
                    console.error('Errore connessione:', e);
                    statusIndicator.classList.remove('connected');
                }

                await new Promise(r => setTimeout(r, 50)); // 20 fps circa
            }
        }

        
        
        /* ---------- INIT & RESIZE ---------- */
        window.addEventListener('load', () => {
            // Prima di ricevere dati reali, si parte con (0,0)
            updateGeometry(0, 0, 0, 0);
            pollState();                   // avvia il loop una sola volta
        });

        window.addEventListener('resize', () => {
            // Ricostruisce le linee se la finestra cambia
            updateGeometry(currentState.x, currentState.y, currentState.robot_x, currentState.robot_y);
        });
    </script>
</body>
</html>